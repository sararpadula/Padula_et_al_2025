---
title: "Padula_2025_Wing_Diff_Analysis"
author: "Sara Padula"
date: "2025-03-13"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Libraries

```{r}
library(dplyr)
library(ggplot2)
library(cowplot)
library(lme4)
library(lmerTest)
library(DHARMa)
library(glmmTMB)
library(car)
library(emmeans)
library(ggpubr)
library(ggdist)
library(patchwork)
library(ggeffects)
library(performance)
library(ggeffects)   
```

## Load data


```{r}
#Loading data
breed <- read.csv("paired_SMI.csv")

#Split by species
bcch_data <- filter(breed, Species == "BCCH")
moch_data <- filter(breed, Species == "MOCH")

#What is the sample size and mean wing difference in...

#MOCH?
nrow(moch_data)

mean(moch_data$Wing_Difference)


#BCCH?
nrow(bcch_data)

mean(bcch_data$Wing_Difference)

```

## Breeding Success Analysis -- Numerical wing difference variable
```{r}
#first egg, removing blank values
bcch_breed.fe <- bcch_data %>% filter(!is.na(First.Egg))
moch_breed.fe <- moch_data %>% filter(!is.na(First.Egg))
nrow(bcch_breed.fe)
nrow(moch_breed.fe)

#clutch size, removing blank values
bcch_breed.cs <- bcch_data %>% filter(!is.na(Egg_Number))
moch_breed.cs <- moch_data %>% filter(!is.na(Egg_Number))
nrow(bcch_breed.cs)
nrow(moch_breed.cs)

#brood size, removing blank values
bcch_breed.bs <- bcch_data %>% filter(!is.na(Nestling_Number))
moch_breed.bs <- moch_data %>% filter(!is.na(Nestling_Number))
nrow(bcch_breed.bs)
nrow(moch_breed.bs)

#nestling size, removing blank values
bcch_breed.mm <- bcch_data %>% filter(!is.na(Avg_Nestling_Weight))
moch_breed.mm <- moch_data %>% filter(!is.na(Avg_Nestling_Weight))
nrow(bcch_breed.mm)
nrow(moch_breed.mm)

#Female SMI, removing blank values
bcch_breed.fs <- bcch_data %>% filter(!is.na(Female_SMI))
moch_breed.fs <- moch_data %>% filter(!is.na(Female_SMI))
nrow(bcch_breed.fs)
nrow(moch_breed.fs)

#Male SMI, removing blank values
bcch_breed.ms <- bcch_data %>% filter(!is.na(Male_SMI))
moch_breed.ms <- moch_data %>% filter(!is.na(Male_SMI))
nrow(bcch_breed.ms)
nrow(moch_breed.ms)

#Provisioning
breed.p <- breed %>% filter(!is.na(Provisioning))
bcch_breed.p <- bcch_data %>% filter(!is.na(Provisioning))
moch_breed.p <- moch_data %>% filter(!is.na(Provisioning))
nrow(bcch_breed.p)
nrow(moch_breed.p)


```

## Modeling date of first egg

```{r}
## Model first egg in BCCH ##

feB1 <- lmer(First.Egg ~ Wing_Difference + Elevation + (1|Year), data = bcch_breed.fe)

summary(feB1)
r2(feB1)
check_model(feB1)
simres <-simulateResiduals(feB1)
plot(simres)



## Model first egg in MOCH ##

feM1 <- lmer(First.Egg ~ Wing_Difference + Elevation + (1|Year), data = moch_breed.fe)

summary(feM1)
r2(feM1)
check_model(feM1)
simres <-simulateResiduals(feM1)
plot(simres)



bcchFEp <- 0.699

mochFEp <- 0.441




```

## Modeling clutch size

```{r}
## Model clutch size in BCCH ##

csB1 <- glmmTMB(Egg_Number ~ Wing_Difference + Elevation, data = bcch_breed.cs, family = compois)
summary(csB1)

simres_bin <- simulateResiduals(csB1)
plot(simres_bin) 



## Model clutch size in MOCH ##

csM1 <- glmmTMB(Egg_Number ~ Wing_Difference + Elevation, data = moch_breed.cs, family = compois)


summary(csM1)
simres_bin <- simulateResiduals(csM1)
plot(simres_bin)




bcchCSp <- 0.55

mochCSp <- 0.016
```

## Modeling brood size

```{r}
## Model brood size in BCCH ##

bsB1 <- glmmTMB(Nestling_Number ~ Wing_Difference + Elevation, data = bcch_breed.bs, family = compois)

summary(bsB1)

simres_bin <- simulateResiduals(bsB1)
plot(simres_bin) 



## Model brood size in MOCH ##

bsM1 <- glmmTMB(Nestling_Number ~ Wing_Difference + Elevation, data = moch_breed.bs, family = compois)


summary(bsM1)
simres_bin <- simulateResiduals(bsM1)
plot(simres_bin)





bcchBSp <- 0.32
mochBSp <- 0.00073

```

## Modeling average nestling mass

```{r}
## Model avg nestling mass in BCCH ##

mmB1 <- lmer(Avg_Nestling_Weight ~ Wing_Difference + Elevation + (1|Year), data = bcch_breed.mm)

summary(mmB1)
r2(mmB1)
check_model(mmB1)
simres <-simulateResiduals(mmB1)
plot(simres)



## Model avg nestling mass in MOCH ##

mmM1 <- lmer(Avg_Nestling_Weight ~ Wing_Difference + Elevation + (1|Year), data = moch_breed.mm)

summary(mmM1)
r2(mmM1)
check_model(mmM1)
simres <-simulateResiduals(mmM1)
plot(simres)





bcchMMp <- 0.641
mochMMp <- 0.0018
```

## Modeling Female SMI

```{r}
## Model female body condition in BCCH ##

fsB1 <- lm(Female_SMI ~ Wing_Difference + Elevation, data = bcch_breed.fs)

summary(fsB1)
r2(fsB1)
check_model(fsB1)
simres <-simulateResiduals(fsB1)
plot(simres)




## Model female body condition in MOCH ##

fsM1 <- lm(Female_SMI ~ Wing_Difference + Elevation, data = moch_breed.fs)

summary(fsM1)
r2(fsM1)
check_model(fsM1)
simres <-simulateResiduals(fsM1)
plot(simres)



bcchFSp <- 0.664

mochFSp <- 0.56989
```

## Modeling male SMI

```{r}
## Model male body condition in BCCH ##

msB1 <- lm(Male_SMI ~ Wing_Difference + Elevation, data = bcch_breed.ms)

summary(msB1)
r2(msB1)
check_model(msB1)
simres <-simulateResiduals(msB1)
plot(simres)




## Model male body condition in MOCH ##

msM1 <- lm(Male_SMI ~ Wing_Difference + Elevation, data = moch_breed.ms)

summary(msM1)
r2(msM1)
check_model(msM1)
simres <-simulateResiduals(msM1)
plot(simres)





bcchMSp <- 0.009
mochMSp <- 0.557


```

## Modeling provisioning rate

```{r}
## Model provisioning in BCCH ##

pB1 <- lm(Provisioning ~ Wing_Difference + Elevation, data = bcch_breed.p)

summary(pB1)
r2(pB1)
check_model(pB1)
simres <-simulateResiduals(pB1)
plot(simres)



## Model male body condition in MOCH ##

pM1 <- lm(Provisioning ~ Wing_Difference + Elevation, data = moch_breed.p)

summary(pM1)
r2(pM1)
check_model(pM1)
simres <-simulateResiduals(pM1)
plot(simres)



bcchPp <- 0.999
mochPp <- 0.62


```

Adjust the p-values to account for multiple comparisons

```{r}
p_values_bcch <- c(bcchFEp, bcchCSp, bcchBSp, bcchMMp, bcchFSp, bcchMSp, bcchPp)

p_values_moch <- c(mochFEp, mochCSp, mochBSp, mochMMp, mochFSp, mochMSp, mochPp)

p_adjusted_bcch <- p.adjust(p_values_bcch, method = "BH")

p_adjusted_moch <- p.adjust(p_values_moch, method = "BH")

p_adjusted_bcch

p_adjusted_moch

```


Visualizing wing difference (numeric) predicting reproductive success variables.

```{r}


sp_cols <- c("MOCH" = "#cc79a7", "BCCH" = "#0072b2")


pred_plot_dual <- function(model_bcch, model_moch,
                           df_bcch, df_moch,
                           y_col, ylab) {
  # predictions
  pb <- ggpredict(model_bcch, terms = "Wing_Difference")
  pm <- ggpredict(model_moch, terms = "Wing_Difference")
  pb$Species <- "BCCH"
  pm$Species <- "MOCH"
  preds <- bind_rows(pb, pm)

  # raw data 
  raw <- bind_rows(
    df_bcch %>% mutate(Species = "BCCH"),
    df_moch %>% mutate(Species = "MOCH")
  )

  ggplot(preds, aes(x = x, y = predicted, color = Species, fill = Species)) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.18, color = NA) +
    geom_line(linewidth = 0.9) +
    geom_point(data = raw,
               aes(x = Wing_Difference, y = .data[[y_col]], color = Species),
               inherit.aes = FALSE, alpha = 0.35, size = 0.8) +
    scale_color_manual(values = sp_cols) +
    scale_fill_manual(values = sp_cols) +
    labs(x = "Wing difference (mm)", y = ylab, color = "Species") +
    theme_minimal(base_size = 9) +
    theme(legend.position = "bottom")
}


p_fe <- pred_plot_dual(
  feB1, feM1,
  bcch_breed.fe %>% filter(!is.na(Wing_Difference), !is.na(First.Egg)),
  moch_breed.fe %>% filter(!is.na(Wing_Difference), !is.na(First.Egg)),
  y_col = "First.Egg",
  ylab = "Pred. date of first egg"
)


p_cs <- pred_plot_dual(
  csB1, csM1,
  bcch_breed.cs %>% filter(!is.na(Wing_Difference), !is.na(Egg_Number)),
  moch_breed.cs %>% filter(!is.na(Wing_Difference), !is.na(Egg_Number)),
  y_col = "Egg_Number",
  ylab = "Pred. clutch size"
)


p_bs <- pred_plot_dual(
  bsB1, bsM1,
  bcch_breed.bs %>% filter(!is.na(Wing_Difference), !is.na(Nestling_Number)),
  moch_breed.bs %>% filter(!is.na(Wing_Difference), !is.na(Nestling_Number)),
  y_col = "Nestling_Number",
  ylab = "Pred. brood size"
)


p_mm <- pred_plot_dual(
  mmB1, mmM1,
  bcch_breed.mm %>% filter(!is.na(Wing_Difference), !is.na(Avg_Nestling_Weight)),
  moch_breed.mm %>% filter(!is.na(Wing_Difference), !is.na(Avg_Nestling_Weight)),
  y_col = "Avg_Nestling_Weight",
  ylab = "Pred. avg. nestling mass (g)"
)


p_fs <- pred_plot_dual(
  fsB1, fsM1,
  bcch_breed.fs %>% filter(!is.na(Wing_Difference), !is.na(Female_SMI)),
  moch_breed.fs %>% filter(!is.na(Wing_Difference), !is.na(Female_SMI)),
  y_col = "Female_SMI",
  ylab = "Pred. female SMI"
)

p_ms <- pred_plot_dual(
  msB1, msM1,
  bcch_breed.ms %>% filter(!is.na(Wing_Difference), !is.na(Male_SMI)),
  moch_breed.ms %>% filter(!is.na(Wing_Difference), !is.na(Male_SMI)),
  y_col = "Male_SMI",
  ylab = "Pred. male SMI"
)


p_pr <- pred_plot_dual(
  pB1, pM1,
  bcch_breed.p %>% filter(!is.na(Wing_Difference), !is.na(Provisioning)),
  moch_breed.p %>% filter(!is.na(Wing_Difference), !is.na(Provisioning)),
  y_col = "Provisioning",
  ylab = "Pred. provisioning rate"
)


allLine <- (p_fe + p_cs + p_bs) / (p_mm + p_fs + p_ms + p_pr) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")

ggsave("wingdiffRepVarPlot.png", plot = allLine, width = 8.5, height = 6.0, dpi = 300)

```


## Does female wing length predict male wing length within pairs?

```{r}

# Subset data by species
mochBreed <- subset(breed, Species == "MOCH")
bcchBreed <- subset(breed, Species == "BCCH")

### ---- MOCH: Does female wing predict male wing? ----

# Linear model
linM1 <- lmer(Male.Wing.Chord ~ Female.Wing.Chord + (1|Year), data = mochBreed)

# Summary of model
summary(linM1)

# Residual diagnostics
linM1_res <- simulateResiduals(linM1)
plot(linM1_res)

### ---- BCCH: Does female wing predict male wing? ----

# Linear model
linB1 <- lmer(Male.Wing.Chord ~ Female.Wing.Chord + (1|Year), data = bcchBreed)

# Summary of model
summary(linB1)

# Residual diagnostics
linB1_res <- simulateResiduals(linB1)
plot(linB1_res)


# Pearson's correlation for MOCH
moch_cor <- cor.test(mochBreed$Female.Wing.Chord, mochBreed$Male.Wing.Chord, method = "pearson")
print(moch_cor)

# Pearson's correlation for BCCH
bcch_cor <- cor.test(bcchBreed$Female.Wing.Chord, bcchBreed$Male.Wing.Chord, method = "pearson")
print(bcch_cor)


```

# Plot the linear models
```{r}

ggplot(breed, aes(x = Female.Wing.Chord, y = Male.Wing.Chord, color = Species)) +
  geom_point(alpha = 0.7) +  
  geom_smooth(method = "lm", se = FALSE) +  
    scale_color_manual(values = c("MOCH" = "#cc79a7", "BCCH" = "#0072b2")) +
  labs(x = "Female Wing Chord", y = "Male Wing Chord") +
  theme_minimal()

```


## Breeding Success Analysis -- categorical wing difference (only male larger categories)

```{r}
head(breed)
breedCat <-breed[breed$Wing_Difference_Category %in% c("Much", "Slightly"), ]

breedCat_moch <- subset(breedCat, Species == "MOCH")
breedCat_bcch <- subset(breedCat, Species == "BCCH")

#first egg, removing blank values
breedCat_bcch.fe <- breedCat_bcch %>% filter(!is.na(First.Egg))
breedCat_moch.fe <- breedCat_moch %>% filter(!is.na(First.Egg))
nrow(breedCat_bcch.fe)
nrow(breedCat_moch.fe)

#clutch size, removing blank values
breedCat_bcch.cs <- breedCat_bcch %>% filter(!is.na(Egg_Number))
breedCat_moch.cs <- breedCat_moch %>% filter(!is.na(Egg_Number))
nrow(breedCat_bcch.cs)
nrow(breedCat_moch.cs)
    
#brood size, removing blank values
breedCat_bcch.bs <- breedCat_bcch %>% filter(!is.na(Nestling_Number))
breedCat_moch.bs <- breedCat_moch %>% filter(!is.na(Nestling_Number))
nrow(breedCat_bcch.bs)
nrow(breedCat_moch.bs)

#nestling size, removing blank values
breedCat_bcch.mm <- breedCat_bcch %>% filter(!is.na(Avg_Nestling_Weight))
breedCat_moch.mm <- breedCat_moch %>% filter(!is.na(Avg_Nestling_Weight))
nrow(breedCat_bcch.mm)
nrow(breedCat_moch.mm)

#Female SMI, removing blank values
breedCat_bcch.fs <- breedCat_bcch %>% filter(!is.na(Female_SMI))
breedCat_moch.fs <- breedCat_moch %>% filter(!is.na(Female_SMI))
nrow(breedCat_bcch.fs)
nrow(breedCat_moch.fs)

#Male SMI, removing blank values
breedCat_bcch.ms <- breedCat_bcch %>% filter(!is.na(Male_SMI))
breedCat_moch.ms <- breedCat_moch %>% filter(!is.na(Male_SMI))
nrow(breedCat_bcch.ms)
nrow(breedCat_moch.ms)

#Provisioning
breedCat_bcch.p <- breedCat_bcch %>% filter(!is.na(Provisioning))
breedCat_moch.p <- breedCat_moch %>% filter(!is.na(Provisioning))
nrow(breedCat_bcch.p)
nrow(breedCat_moch.p)

```


## Modeling date of first egg

```{r}
## Model first egg in BCCH ##

feBc <- lmer(First.Egg ~ Wing_Difference_Category + Elevation + (1|Year), data = breedCat_bcch.fe)

summary(feBc)
r2(feBc)
check_model(feBc)
simres <-simulateResiduals(feBc)
plot(simres)




## Model first egg in MOCH ##

feMc <- lmer(First.Egg ~ Wing_Difference_Category + Elevation + (1|Year), data = breedCat_moch.fe)

summary(feMc)
r2(feMc)
check_model(feMc)
simres <-simulateResiduals(feMc)
plot(simres)



bcchFEp <- 0.54

mochFEp <- 0.33



```


## Modeling clutch size

```{r}
## Model clutch size in BCCH ##

csBc <- lm(Egg_Number ~ Wing_Difference_Category + Elevation, data = breedCat_bcch.cs)

summary(csBc)
r2(csBc)
check_model(csBc)
simres <-simulateResiduals(csBc)
plot(simres)




## Model clutch size in MOCH ##

csMc <- lmer(Egg_Number ~ Wing_Difference_Category + Elevation + (1|Year), data = breedCat_moch.cs)

summary(csMc)
r2(csMc)
check_model(csMc)
simres <-simulateResiduals(csMc)
plot(simres)



bcchCSp <- 0.20

mochCSp <- 0.37

```

## Modeling brood size

```{r}
## Model brood size in BCCH ##

bsBc <- lm(Nestling_Number ~ Wing_Difference_Category + Elevation, data = breedCat_bcch.bs)

summary(bsBc)
r2(bsBc)
check_model(bsBc)
simres <-simulateResiduals(bsBc)
plot(simres)


## Model brood size in MOCH ##

bsMc <- lmer(Nestling_Number ~ Wing_Difference_Category + Elevation + (1|Year), data = breedCat_moch.bs)

summary(bsMc)
r2(bsMc)
check_model(bsMc)
simres <-simulateResiduals(bsMc)
plot(simres)




bcchBSp <- 0.94

mochBSp <- 0.14

```

## Modeling average nestling mass

```{r}
## Model average nestling mass in BCCH ##

mmBc <- lmer(Avg_Nestling_Weight ~ Wing_Difference_Category + Elevation + (1|Year), data = breedCat_bcch.mm)

summary(mmBc)
r2(mmBc)
check_model(mmBc)
simres <-simulateResiduals(mmBc)
plot(simres)




## Model average nestling mass in MOCH ##

mmMc <- lmer(Avg_Nestling_Weight ~ Wing_Difference_Category + Elevation + (1|Year), data = breedCat_moch.mm)

summary(mmMc)
r2(mmMc)
check_model(mmMc)
simres <-simulateResiduals(mmMc)
plot(simres)




bcchMMp <- 0.89

mochMMp <- 0.009

```


## Modeling female SMI

```{r}
## Model female SMI in BCCH ##

fsBc <- lm(Female_SMI ~ Wing_Difference_Category + Elevation, data = breedCat_bcch.fs)

summary(fsBc)
r2(fsBc)
check_model(fsBc)
simres <-simulateResiduals(fsBc)
plot(simres)




## Model female SMI in MOCH ##

fsMc <- lm(Female_SMI ~ Wing_Difference_Category + Elevation, data = breedCat_moch.fs)

summary(fsMc)
r2(fsMc)
check_model(fsMc)
simres <-simulateResiduals(fsMc)
plot(simres)




bcchFSp <- 0.66

mochFSp <- 0.83

```


## Modeling male SMI
```{r}
## Model male SMI in BCCH ##

msBc <- lm(Male_SMI ~ Wing_Difference_Category + Elevation, data = breedCat_bcch.ms)

summary(msBc)
r2(msBc)
check_model(msBc)
simres <-simulateResiduals(msBc)
plot(simres)




## Model male SMI in MOCH ##

msMc <- lm(Male_SMI ~ Wing_Difference_Category + Elevation, data = breedCat_moch.ms)

summary(msMc)
r2(msMc)
check_model(msMc)
simres <-simulateResiduals(msMc)
plot(simres)




bcchMSp <- 0.08

mochMSp <- 0.49

```

## Modeling provisioning rate

```{r}
## Model provisioning in BCCH ##

pBc <- lm(Provisioning ~ Wing_Difference_Category + Elevation, data = breedCat_bcch.p)

summary(pBc)
r2(pBc)
check_model(pBc)
simres <-simulateResiduals(pBc)
plot(simres)




## Model Provisioning in MOCH ##

pMc <- lmer(Provisioning ~ Wing_Difference_Category + Elevation + (1|Year), data = breedCat_moch.p)

summary(pMc)
r2(pMc)
check_model(pMc)
simres <-simulateResiduals(pMc)
plot(simres)




bcchPp <- 0.55

mochPp <- 0.81

```
Adjust the p-values to account for multiple comparisons

```{r}
p_values_bcch <- c(bcchFEp, bcchCSp, bcchBSp, bcchMMp, bcchFSp, bcchMSp, bcchPp)

p_values_moch <- c(mochFEp, mochCSp, mochBSp, mochMMp, mochFSp, mochMSp, mochPp)

p_adjusted_bcch <- p.adjust(p_values_bcch, method = "BH")

p_adjusted_moch <- p.adjust(p_values_moch, method = "BH")

p_adjusted_bcch

p_adjusted_moch

```


## Plotting wing difference category comparisons

```{r}
# ---- packages ----
library(dplyr)
library(ggplot2)
library(patchwork)

sp_cols <- c("MOCH" = "#cc79a7", "BCCH" = "#0072b2")

# helper to build a species-comparison boxplot for a given response
mk_box <- function(df, y, ylab) {
  ggplot(df, aes(x = Species, y = .data[[y]], fill = Species)) +
    geom_boxplot(width = 0.7, outlier.shape = NA, alpha = 0.7) +
    # optional: show raw points (jittered)
    geom_jitter(aes(color = Species), width = 0.15, alpha = 0.35, size = 0.9, show.legend = FALSE) +
    scale_fill_manual(values = sp_cols, guide = "none") +
    scale_color_manual(values = sp_cols, guide = "none") +
    labs(x = NULL, y = ylab) +
    facet_wrap(~ Wing_Difference_Category, nrow = 1) +
    theme_minimal(base_size = 9) +
    theme(
      strip.text = element_text(face = "bold"),
      axis.text.x = element_text(angle = 0, vjust = 0.5),
      panel.grid.minor = element_blank()
    )
}

# Build per-response boxplots from your already-filtered data frames
p_fe <- mk_box(
  bind_rows(breedCat_bcch.fe, breedCat_moch.fe),
  y = "First.Egg", ylab = "Date of first egg"
)

p_cs <- mk_box(
  bind_rows(breedCat_bcch.cs, breedCat_moch.cs),
  y = "Egg_Number", ylab = "Clutch size"
)

p_bs <- mk_box(
  bind_rows(breedCat_bcch.bs, breedCat_moch.bs),
  y = "Nestling_Number", ylab = "Brood size"
)

p_mm <- mk_box(
  bind_rows(breedCat_bcch.mm, breedCat_moch.mm),
  y = "Avg_Nestling_Weight", ylab = "Avg. nestling mass (g)"
)

p_fs <- mk_box(
  bind_rows(breedCat_bcch.fs, breedCat_moch.fs),
  y = "Female_SMI", ylab = "Female SMI"
)

p_ms <- mk_box(
  bind_rows(breedCat_bcch.ms, breedCat_moch.ms),
  y = "Male_SMI", ylab = "Male SMI"
)

p_pr <- mk_box(
  bind_rows(breedCat_bcch.p, breedCat_moch.p),
  y = "Provisioning", ylab = "Provisioning rate"
)

# Combine into a paneled figure (3 x 3 layout; last row has two plots)
panel_box <- (p_fe + p_cs + p_bs) /
             (p_mm + p_fs + p_ms) /
             (p_pr + plot_spacer() + plot_spacer())

# Save
ggsave("breedCat_species_boxpanels.png", panel_box, width = 10, height = 8, dpi = 300)



```
